<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Compile and Run - The x4c Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The x4c Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="compile-and-run"><a class="header" href="#compile-and-run">Compile and Run</a></h1>
<p>In the previous section we put together a hello world P4 program. In this
section we run that program over a software ASIC called SoftNpu. One of the
capabilities of the <code>x4c</code> compiler is using P4 code directly from Rust code
and we'll be doing that in this example.</p>
<p>Below is a Rust program that imports the P4 code developed in the last section,
loads it onto a SoftNpu ASIC instance, and sends some packets through it.  We'll
be looking at this program piece-by-piece in the remainder of this section.</p>
<p>All of the programs in this book are available as buildable programs in the
<a href="https://github.com/oxidecomputer/p4">oxidecomputer/p4</a> repository in the
<code>book/code</code> directory.</p>
<pre><code class="language-rust">use tests::softnpu::{RxFrame, SoftNpu, TxFrame};
use tests::{expect_frames};

const NUM_PORTS: u16 = 3;

p4_macro::use_p4!(p4 = "book/code/src/bin/hello-world.p4", pipeline_name = "hello");

fn main() -&gt; Result&lt;(), anyhow::Error&gt; {
    let pipeline = main_pipeline::new(NUM_PORTS);
    let mut npu = SoftNpu::new(NUM_PORTS, pipeline, false);
    let phy1 = npu.phy(0);
    let phy2 = npu.phy(1);
    let phy3 = npu.phy(2);

    npu.run();

    // Expect this packet to be dropped
    phy3.send(&amp;[TxFrame::new(phy3.mac, 0, b"to the bit bucket with you!")])?;

    phy1.send(&amp;[TxFrame::new(phy2.mac, 0, b"hello")])?;
    expect_frames!(phy2, &amp;[RxFrame::new(phy1.mac, 0, b"hello")]);

    phy2.send(&amp;[TxFrame::new(phy1.mac, 0, b"world")])?;
    expect_frames!(phy1, &amp;[RxFrame::new(phy2.mac, 0, b"world")]);

    Ok(())
}</code></pre>
<p>The program starts with a few Rust imports.</p>
<pre><code class="language-rust">use tests::softnpu::{RxFrame, SoftNpu, TxFrame};
use tests::{expect_frames};</code></pre>
<p>This first line is the SoftNpu implementation that lives in the <code>test</code> crate of
the <code>oxidecomputer/p4</code> repository. The second is a helper macro that allows us
to make assertions about frames coming from a SoftNpu "physical" port (referred
to as a phy).</p>
<p>The next line is using the <code>x4c</code> compiler to translate P4 code into Rust code
and dumping that Rust code into our program. The macro literally expands into
the Rust code emitted by the compiler for the specified P4 source file.</p>
<pre><code class="language-rust">p4_macro::use_p4!(p4 = "book/code/src/bin/hello-world.p4", pipeline_name = "hello");</code></pre>
<p>The main artifact this produces is a Rust <code>struct</code> called <code>main_pipeline</code> which is used
in the code that comes next.</p>
<pre><code class="language-rust">let pipeline = main_pipeline::new(NUM_PORTS);
let mut npu = SoftNpu::new(NUM_PORTS, pipeline, false);
let phy1 = npu.phy(0);
let phy2 = npu.phy(1);
let phy3 = npu.phy(2);</code></pre>
<p>This code is instantiating a pipeline object that encapsulates the logic of our
P4 program. Then a SoftNpu ASIC is constructed with three ports and our pipeline
program. SoftNpu objects provide a <code>phy</code> method that takes a port index to get a
reference to a port that is attached to the ASIC. These port objects are used to
send and receive packets through the ASIC, which uses our compiled P4 code to
process those packets.</p>
<p>Next we run our program on the SoftNpu ASIC.</p>
<pre><code class="language-rust">npu.run();</code></pre>
<p>However, this does not actually do anything until we pass some packets through
it, so lets do that.</p>
<pre><code class="language-rust">// Expect this packet to be dropped
phy3.send(&amp;[TxFrame::new(phy3.mac, 0, b"to the bit bucket with you!")])?;</code></pre>
<p>This code transmit an Ethernet frame through the third port of the
ASIC with a payload value of "to the bit bucket with you!".  The
<code>phy3.mac</code> parameter of the <code>TxFrame</code> sets the destination MAC address
and the <code>0</code> for the second parameter is the ethertype used in the
outgoing Ethernet frame.</p>
<p>Based on the logic in our P4 program, we would expect this packet to
be dropped by the switch, i.e. it will not be sent out of any port at
all.  This is because the table lookup on the ingress port value of 2
would get a miss, and the table would execute the default action
<code>drop</code>.  Thus we do not call <code>expect_frames!</code> here, as we do for the
test packets below.</p>
<pre><code class="language-rust">phy1.send(&amp;[TxFrame::new(phy2.mac, 0, b"hello")])?;</code></pre>
<p>This code transmits an Ethernet frame through the first port of the ASIC with a
payload value of <code>"hello"</code>.</p>
<p>Based on the logic in our P4 program, we would expect this packet to come out
the second port. Let's test that.</p>
<pre><code class="language-rust">expect_frames!(phy2, &amp;[RxFrame::new(phy1.mac, 0, b"hello")]);</code></pre>
<p>This code reads a packet from the second ASIC port <code>phy2</code> (blocking until there
is a packet available) and asserts the following.</p>
<ul>
<li>The Ethernet payload is the byte string <code>"hello"</code>.</li>
<li>The source MAC address is that of <code>phy1</code>.</li>
<li>The ethertype is <code>0</code>.</li>
</ul>
<p>To complete the hello world program, we do the same thing in the opposite
direction. Sending the byte string <code>"world"</code> as an Ethernet payload into port 2
and assert that it comes out port 1.</p>
<pre><code class="language-rust">phy2.send(&amp;[TxFrame::new(phy1.mac, 0, b"world")])?;
expect_frames!(phy1, &amp;[RxFrame::new(phy2.mac, 0, b"world")]);</code></pre>
<p>The <code>expect_frames</code> macro will also print payloads and the port they came from.</p>
<p>When we run this program we see the following.</p>
<pre><code class="language-bash">$ cargo run --bin hello-world
   Compiling x4c-book v0.1.0 (/home/ry/src/p4/book/code)
    Finished dev [unoptimized + debuginfo] target(s) in 2.05s
     Running `target/debug/hello-world`
[phy2] hello
[phy1] world
</code></pre>
<h2 id="softnpu-and-target-x4c-use-cases"><a class="header" href="#softnpu-and-target-x4c-use-cases">SoftNpu and Target <code>x4c</code> Use Cases.</a></h2>
<p>The example above shows using <code>x4c</code> compiled code is a setting that is only
really useful for testing the logic of compiled pipelines and demonstrating how
P4 and <code>x4c</code> compiled pipelines work. This begs the question of what the target
use cases for <code>x4c</code> actually are. It also raises question, why build <code>x4c</code> in the
first place? Why not use the established reference compiler <code>p4c</code> and its
associated reference behavioral model <code>bmv2</code>?</p>
<p><em>A key difference between <code>x4c</code> and the <code>p4c</code> ecosystem is how compilation
and execution concerns are separated. <code>x4c</code> generates free-standing pipelines
that can be used by other code, <code>p4c</code> generates JSON that is interpreted and run
by <code>bmv2</code></em>.</p>
<p>The example above shows how the generation of free-standing runnable pipelines
can be used to test the logic of P4 programs in a lightweight way. We went from
P4 program source to actual packet processing using nothing but the Rust
compiler and package manager. The program is executable in an operating system
independent way and is a great way to get CI going for P4 programs.</p>
<p>The free-standing pipeline approach is not limited to self-contained use cases
with packets that are generated and consumed in-program. <code>x4c</code> generated code
conforms to a well defined
<a href="https://oxidecomputer.github.io/p4/p4rs/index.html"><code>Pipeline</code></a>
interface that can be used to run pipelines anywhere <code>rustc</code> compiled code can
run. Pipelines are even dynamically loadable through <code>dlopen</code> and the like.</p>
<p>The <code>x4c</code> authors have used <code>x4c</code> generated pipelines to create virtual ASICs
inside hypervisors that transit real traffic between virtual machines, as well
as P4 programs running inside zones/containers that implement NAT and tunnel
encap/decap capabilities. The mechanics of I/O are deliberately outside the
scope of <code>x4c</code> generated code. Whether you want to use DLPI, XDP, libpcap,
PF_RING, DPDK, etc., is up to you and the harness code you write around your
pipelines!</p>
<p>The win with <code>x4c</code> is flexibility. You can compile a free-standing P4 pipeline
and use that pipeline wherever you see fit. The near-term use for <code>x4c</code> focuses
on development and evaluation environments. If you are building a system around
P4 programmable components, but it's not realistic to buy all the
switches/routers/ASICs at the scale you need for testing/development, <code>x4c</code> is an
option. <code>x4c</code> is also a good option for running packets through your pipelines
in a lightweight way in CI.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="01-02-hello_world.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="02-by-example.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="01-02-hello_world.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="02-by-example.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="https://storage.googleapis.com/goodwu-public/highlight.min.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
